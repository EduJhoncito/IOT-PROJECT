{% extends 'base.html' %}
{% block title %}Dashboard IGP{% endblock %}
{% block content %}
<section class="hero-panel">
    <div class="hero-panel__info">
        <span class="hero-highlight">IGP · Data Stories</span>
        <p class="eyebrow">Monitoreo estratégico · IGP</p>
        <h1>Panel operativo de sensores</h1>
        <p class="hero-subtitle">{{ filter_description }}</p>
    </div>
    <div class="hero-status">
        <p>Última lectura: <strong>{{ last_update }}</strong></p>
        <p>Fuente del día: <strong>{{ daily_stats.source|default:"base de datos" }}</strong></p>
    </div>
</section>

<form method="get" class="filter-bar">
    <div class="filter-row">
        <label>
            <div class="filter-label">
                <span>Año</span>
                <span class="hint">2023 – {{ filter_range.end_year }}</span>
            </div>
            <input class="filter-input" type="number" name="year" min="2023" max="{{ filter_range.end_year }}" placeholder="Ej: {{ filter_range.end_year }}" value="{{ active_filters.year|default_if_none:'' }}">
        </label>
        <label>
            <div class="filter-label">
                <span>Mes</span>
                <span class="hint">1 = Ene · 12 = Dic</span>
            </div>
            <input class="filter-input" type="number" name="month" min="1" max="12" placeholder="1 - 12" value="{{ active_filters.month|default_if_none:'' }}">
        </label>
        <label>
            <div class="filter-label">
                <span>Día</span>
                <span class="hint">Opcional · 1 – 31</span>
            </div>
            <input class="filter-input" type="number" name="day" min="1" max="31" placeholder="1 - 31" value="{{ active_filters.day|default_if_none:'' }}">
        </label>
        <div class="filter-actions">
            <button type="submit">Aplicar filtros</button>
            {% if filters_applied %}
                <a class="ghost-button ghost-button--small" href="{{ filter_reset_url }}">Limpiar</a>
            {% endif %}
        </div>
    </div>
</form>

<section class="realtime-panel">
    <div class="panel-header">
        <div>
            <p class="eyebrow">Simulación · SSE</p>
            <h2>Tiempo real</h2>
            <p class="hero-subtitle">Generación de paquetes cada 5 segundos mientras se integra Redis.</p>
        </div>
        <div class="live-status">
            <span>Estado stream:</span>
            <span class="status-pill" id="live-status">Conectando…</span>
        </div>
    </div>
    <div class="live-metrics">
        <article class="live-metric-card">
            <p class="live-metric__label">Registros del día</p>
            <p class="live-metric__value" id="live-total">0</p>
            <p class="live-metric__helper">Samples recibidos</p>
        </article>
        <article class="live-metric-card">
            <p class="live-metric__label">Humedad promedio</p>
            <p class="live-metric__value" id="live-humidity"><span class="value">0.0</span><span class="unit">%</span></p>
            <p class="live-metric__helper">Basado en streaming</p>
        </article>
        <article class="live-metric-card">
            <p class="live-metric__label">Alertas por inclinación</p>
            <p class="live-metric__value" id="live-tilt">0</p>
            <p class="live-metric__helper">Eventos del día</p>
        </article>
        <article class="live-metric-card">
            <p class="live-metric__label">Golpes detectados</p>
            <p class="live-metric__value" id="live-hit">0</p>
            <p class="live-metric__helper">Impactos críticos</p>
        </article>
        <article class="live-metric-card">
            <p class="live-metric__label">Último timestamp</p>
            <p class="live-metric__value" id="live-last-ts">--</p>
            <p class="live-metric__helper">Seq <span id="live-last-seq">--</span></p>
        </article>
    </div>
    <div class="live-feed">
        <div class="chart-card__header">
            <h3>Payload recibido</h3>
            <p>JSON simulado respetando el formato del hardware.</p>
        </div>
        <pre id="live-json">Esperando datos…</pre>
    </div>
</section>

<section class="stat-grid">
    {% for insight in daily_insights %}
        <article class="stat-card">
            <p class="stat-card__label">{{ insight.label }}</p>
            <p class="stat-card__value">
                {{ insight.value }}{% if insight.suffix %}<span>{{ insight.suffix }}</span>{% endif %}
            </p>
            <p class="stat-card__helper">{{ insight.helper }}</p>
        </article>
    {% empty %}
        <p class="empty-state">No hay lecturas para el día de hoy.</p>
    {% endfor %}
</section>

<section class="kpi-grid">
    {% for kpi in kpi_cards %}
        <article class="kpi-card">
            <div>
                <p class="kpi-label">{{ kpi.label }}</p>
                <p class="kpi-value">
                    {{ kpi.value }}{% if kpi.suffix %}<span>{{ kpi.suffix }}</span>{% endif %}
                </p>
            </div>
            <p class="kpi-trend {{ kpi.trend_class }}">{{ kpi.trend_text }}</p>
            <p class="kpi-helper">{{ kpi.helper }}</p>
        </article>
    {% empty %}
        <p class="empty-state">Carga la data histórica para habilitar los KPI.</p>
    {% endfor %}
</section>

<section class="storytelling">
    <h2>Storytelling geofísico</h2>
    <ul>
        {% for item in storyline %}
            <li>{{ item }}</li>
        {% empty %}
            <li>Aún no existen narrativas porque no hay registros.</li>
        {% endfor %}
    </ul>
</section>

<section class="chart-grid" id="dashboard-charts">
    <article class="chart-card">
        <div class="chart-card__header">
            <h3>Promedio mensual de vibración (pulse)</h3>
            <p>Promedio mostrado en unidades del sensor.</p>
        </div>
        <canvas id="pulseChart"></canvas>
    </article>
    <article class="chart-card">
        <div class="chart-card__header">
            <h3>Tendencia de humedad calibrada</h3>
            <p>Señal suavizada con media móvil de 3 meses.</p>
        </div>
        <canvas id="humidityChart"></canvas>
    </article>
    <article class="chart-card event-card">
        <div class="chart-card__header">
            <h3>Eventos críticos</h3>
            <p>Proporción acumulada por tipo de alerta.</p>
        </div>
        <div class="event-list">
            {% for event in event_breakdown %}
                <div class="event-row">
                    <div>
                        <p>{{ event.label }}</p>
                        <small>{{ event.value }} eventos</small>
                    </div>
                    <div class="event-progress">
                        <span style="width: {{ event.percent }}%"></span>
                    </div>
                    <p class="event-percent">{{ event.percent }}%</p>
                </div>
            {% empty %}
                <p class="empty-state">No se registran eventos para graficar.</p>
            {% endfor %}
        </div>
    </article>
</section>
{% endblock %}

{% block extra_js %}
<script>
    window.dashboardData = JSON.parse('{{ chart_data|escapejs }}');
    window.streamEndpoint = "{% url 'monitoring:sensor-stream' %}";
    window.simStreamEnabled = {{ sim_stream_enabled|yesno:"true,false" }};
</script>
{% endblock %}
